# CAP 原理
<!-- toc -->
## 定义

![](/分布式/image/cap.png)
> 
+ Consistency (一致性)
    - “all nodes see the same data at the same time”,即更新操作成功并返回客户端后，所有节点在同一时间的数据完全一致，这就是分布式的一致性。一致性的问题在并发系统中不可避免，对于客户端来说，一致性指的是并发访问时更新过的数据如何获取的问题。从服务端来看，则是更新如何复制分布到整个系统，以保证数据最终一致。
+ Availability (可用性)
    - 可用性指“Reads and writes always succeed”，即服务一直可用，而且是正常响应时间。好的可用性主要是指系统能够很好的为用户服务，不出现用户操作失败或者访问超时等用户体验不好的情况。
+ Partition Tolerance (分区容错性)
    - 即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性或可用性的服务。
    - 分区容错性要求能够使应用虽然是一个分布式系统，而看上去却好像是在一个可以运转正常的整体。比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统需求，对于用户而言并没有什么体验上的影响。

## 一致性
+ CAP里面C指的是线性一致性.
+ 强一致性和弱一致性只是一种统称，按照从强到弱，可以划分为
    - 线性一致性 Linearizability consistency ，也叫原子性
    - 顺序一致性 Sequential consistency
    - 因果一致性 Causal consistency
    - 最终一致性 Eventual consistency
+ 强一致性包括线性一致性和顺序一致性，其他的如最终一致都是弱一致性。

### 线性一致性
+ 简单点说就是能保证操作的时间顺序，所有操作在一个全局时钟下，如果操作A发生了，那么在它后面的操作B一定能读到操作A的数据。
+ 在单机情况下，使用机器的系统时钟就可以了，但是在分布式系统中，每个机器的系统时钟无法完全对齐，所以在不同的机器上并行执行操作，很难界定到底哪个操作在前，哪个操作在后。
+ 要求
    1. 任何一次读都能读到某个数据的最近一次写的数据。
    2. 系统中的所有进程，看到的操作顺序，都与全局时钟下的顺序一致。

![](/分布式/image/linear.png)
> 当P1和P2的操作执行完后，P3在之后时间的操作一定能看到P1和P2操作之后的值。  
> read(x) -> {1,2} 表示，在这一时刻读x的可能值是1或者2，但是不会是初始值。

### 顺序一致性
+ 不要求全局一致，但是要求操作顺序，所有人看到的操作顺序都一样。
+ 比如两个机器上的A和B两个操作，在全局时钟下可能是A在前B在后，但是实际执行时A在的机器可能处理慢了，导致是B先执行，A再执行，但是只有其他的机器在后面的时刻读时，只要保证都是先读到B，再读到A就可以了。

![](/%E5%88%86%E5%B8%83%E5%BC%8F/image/seq.png)

### 线性和顺序比较

![](/分布式/image/demo.png)

+ a：满足顺序不满足线性，可以P2先执行，P1再执行，顺序符合，不符合全局时间窗口
+ b：都符合
+ c：都不符合，P1和P2在保证各自顺序的情况下，不论怎么组合，都不一致。

### 因果一致性
+ 相比于顺序一致性，因果一致性的要求会低一些：它仅要求有因果关系的操作顺序是一致的，没有因果关系的操作顺序是随机的。
+ 举个例子：假设时间顺序位：A发布了视频1，B对视频1进行了评论1，C发布了视频2，对于用户D来说，下面的情况都符合因果一致性
    - D先看到视频1以及评论1，后看到视频2
    - D先看到视频2，然后看到视频1及评论1
+ 但是如果D先看了评论1又看到的视频1，那这个就不符合因果一致。

### 最终一致性
经过一段时间后，节点间的数据达到最终一致。


## 分区
> 摘自 https://www.zhihu.com/question/54105974/answer/139037688

> 一个分布式系统里面，节点组成的网络本来应该是连通的。然而可能因为一些故障，使得有些节点之间不连通了，整个网络就分成了几块区域。数据就散布在了这些不连通的区域中。这就叫分区。

> 当你一个数据项只在一个节点中保存，那么分区出现后，和这个节点不连通的部分就访问不到这个数据了。这时分区就是无法容忍的。

> 提高分区容忍性的办法就是一个数据项复制到多个节点上，那么出现分区之后，这一数据项就可能分布到各个区里。容忍性就提高了。

> 然而，要把数据复制到多个节点，就会带来一致性的问题，就是多个节点上面的数据可能是不一致的。要保证一致，每次写操作就都要等待全部节点写成功，而这等待又会带来可用性的问题。

> 总的来说就是，数据存在的节点越多，分区容忍性越高，但要复制更新的数据就越多，一致性就越难保证。为了保证一致性，更新所有节点数据所需要的时间就越长，可用性就会降低。


## 其他
> + 如果我们选择了 CA 而放弃了 P，那么当发生分区现象时，为了保证 C，系统需要禁止写入。也就是，当有写入请求时，系统不可用。这与 A 冲突了，因为 A 要求系统是可用的。因此，分布式系统理论上不可能选择 CA 架构，只能选择 CP 或者 AP 架构。

> + ZooKeeper一致性：从整体（read 操作 +write 操作）上来说是 sequential consistency，写操作实现了 Linearizability。

> + etcd读写都做了线性一致，即 etcd 是标准的强一致性保证。


## 参考链接
- [CAP Theorem for Databases: Consistency, Availability & Partition Tolerance](https://www.bmc.com/blogs/cap-theorem/)
- [分布式系统架构中CAP原理及案例](https://cloud.tencent.com/developer/article/1554867)
- [05 一致性与 CAP 模型：为什么需要分布式一致性？](http://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/24%E8%AE%B2%E5%90%83%E9%80%8F%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93-%E5%AE%8C/05%20%20%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%20CAP%20%E6%A8%A1%E5%9E%8B%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%9F.md)
- [共识、线性一致性与顺序一致性](https://segmentfault.com/a/1190000022248118)
- [CAP理论中的P到底是个什么意思？](https://www.zhihu.com/question/54105974/answer/139037688)