# Java 性能监测
<!-- toc -->


## JMeter
jmeter是一个性能测试工具，我们可以用它来模拟请求，方便我们来测试各种工具。

ubuntu 安装
```
sudo apt-get install jmeter
```
执行
```
jmeter -n -t invoke.jmx -l result.csv
```

## jstack

### 使用技巧
* 基本用法：`jstack pid`
* 指定有意义的线程名，jstack 会打印出所有线程的堆栈信息，所以指定有意义的线程名可以让我们快速定位到对应的线程信息。

## jstat
* [基本使用](https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstat.html)

### gc 总览
```
jstat -t <lines> -gcutil <pid> <interval> <count>
```
参数说明
* lines: 每隔多少行输出一个header
* pid: 进程id
* interval：采样的时间间隔，默认ms，可以指定1s表示每秒采集一次
* count：采样次数

输出结果
* S0：Survivor 0 空间使用率
* S1: Survivor 1 空间使用率
* E：Eden 空间使用率
* O：Old 空间使用率
* M：元数据空间使用率
* CCS：Compressed Class space
* YGC: 年轻代垃圾回收次数
* FGC：老年代垃圾回收次数
* GCT：垃圾回收总的耗时
* CGC：A new GC performance counter has been added for pauses during the concurrent phase. This counter will be listed by jstat under the CGC (concurrent GC) heading. This information is only available for GCs with a concurrent phase and is GC specific:
  - G1 includes remark and cleanup pauses
  - CMS includes initial mark and remark pauses
  - For CMS, these pauses were previously included in the time listed by jstat under the FGC (full GC) heading.
  - 表示并行gc阶段STW（stop the world）的次数
* CGCT - 并行gc期间STW耗时

### 其他命令

* `jstat -gc <pid>`: 输出垃圾回收的详细信息，其中 C 表示 Capacity 即总量，U 表示Used，即使用量
* `jstat -gccapacity <pid>`：和gc命令类似，会额外数据各区域的最大和最小空间
  - NGCMN : 新生代占用的最小空间
  - NGCMX : 新生代占用的最大空间
  - OGCMN : 老年代占用的最小空间
  - OGCMX : 老年代占用的最大空间
  - OGC：当前年老代的容量 (KB)
  - OC：当前年老代的空间 (KB)
  - PGCMN : perm占用的最小空间
  - PGCMX : perm占用的最大空间
* `jstat -gcnew <pid>`：输出年轻代的信息
* `jstat -gcold <pid>`：输出老年代的信息

## jmap
+ `jmap -histo:live <pid> | less`： 打印堆的统计信息，live 表示打印存活的对象(加上该选项会执行一次full gc，因为要确定存活的对象)，默认会将所有信息打印出来，所以加上less可以翻页查看
  - B  byte
  - C  char
  - D  double
  - F  float
  - I  int
  - J  long
  - Z  boolean
  - [  数组，如[I表示int[]
  - [L+类名 其他对象
+ `jmap -dump:live,format=b,file=dump.hporf <pid>`：将堆的dump存到文件中，可以使用MAT，JvisualVM等工具查看堆使用情况

## 自动存储dump
可以在启动java 程序指定参数，当发生OOM时，自动转存dump。
```
java -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<file-or-dir-path>
```

## jinfo
- `jinfo -flags <pid>` 输出对应java进程的全部参数

## 实例
假设有下面的代码
```java
@RestController
public class HelloController {

    private static final Logger logger = LoggerFactory.getLogger(HelloController.class);
    private static final List<Long> GLOBAL_SET = new ArrayList<>();

    @RequestMapping("/add")
    public Map<String, Object> addToMemory() {
        for (int i = 0; i < 1000; i++) {
            GLOBAL_SET.add(ThreadLocalRandom.current().nextLong());
        }
        logger.info("count {}", GLOBAL_SET.size());
        Map<String, Object> map = new HashMap<>();
        map.put("result", "success");
        return map;
    }
}
```
这段代码会一直往一个全局的List中添加值，这样运行一段时间之后就会出现OOM，我们运行这个实例，使用具体的工具来监测这个代码。

为了能够快速的OOM，我们在启动时指定一个较小的内存
```
java -XX:+HeapDumpOnOutOfMemoryError -Xmx128M -jar tool-test.jar
```
然后启动 jstat，监测jvm的gc情况
```
jstat  -gcutil -h 10 22562 1s > stat.perf
```
然后我们通过jmeter，大量的请求add接口，请求一会之后，jvm就出现了OOM，
```
Exception in thread "http-nio-8080-exec-1" java.lang.OutOfMemoryError: Java heap space
```
然后我们看下stat.perf，以下截取了部分内容，我们可以看到到后面old区满了之后，一直再进行full gc。
```
S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  55.56  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  80.00  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00  88.89  24.34  97.23  92.39      7    0.111     0    0.000     4    0.013    0.124
  0.00 100.00   9.09  36.06  97.06  91.57      8    0.129     0    0.000     4    0.013    0.142
  0.00 100.00  22.73  38.33  96.83  91.57      8    0.129     0    0.000     4    0.013    0.142
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00 100.00  36.36  42.88  97.29  91.57      8    0.129     0    0.000     4    0.013    0.142
  0.00 100.00  50.00  63.33  97.30  91.57      8    0.129     0    0.000     4    0.013    0.142
  0.00 100.00  70.45  63.33  97.30  91.57      8    0.129     0    0.000     4    0.013    0.142
  0.00 100.00   4.17  71.65  96.92  91.60      9    0.200     0    0.000     4    0.013    0.213
  0.00 100.00  45.83  71.65  96.92  91.60      9    0.200     0    0.000     4    0.013    0.213
  0.00 100.00  10.53  53.63  96.48  90.13     10    0.230     0    0.000     6    0.028    0.258
  0.00 100.00  42.11  53.63  96.48  90.13     10    0.230     0    0.000     6    0.028    0.258
  0.00 100.00  73.68  53.63  96.48  90.13     10    0.230     0    0.000     6    0.028    0.258
  0.00 100.00  18.18  64.96  96.48  90.13     11    0.248     0    0.000     6    0.028    0.276
  0.00 100.00  40.91  64.96  96.48  90.13     11    0.248     0    0.000     6    0.028    0.276
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00 100.00  10.00  81.95  96.48  90.13     12    0.265     0    0.000     7    0.038    0.303
  0.00 100.00  45.00  81.95  96.48  90.13     12    0.265     0    0.000     8    0.038    0.303
  0.00 100.00  80.00  81.95  96.48  90.13     12    0.265     0    0.000     8    0.038    0.303
  0.00 100.00  66.67  80.53  96.48  90.13     14    0.296     0    0.000     8    0.038    0.334
  0.00 100.00   0.00  68.15  96.48  90.13     16    0.325     0    0.000    10    0.046    0.371
  0.00 100.00  36.36  73.41  96.48  90.13     17    0.332     0    0.000    10    0.046    0.379
  0.00 100.00  20.00  88.36  96.48  90.13     18    0.344     0    0.000    12    0.056    0.400
  0.00 100.00  25.00  87.07  96.48  90.13     19    0.361     0    0.000    12    0.056    0.416
  0.00 100.00  80.00  73.24  96.48  90.13     22    0.378     0    0.000    14    0.064    0.442
  0.00 100.00   0.00  78.15  96.48  90.13     23    0.393     0    0.000    14    0.064    0.457
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00 100.00  87.50  77.17  96.48  90.13     24    0.393     0    0.000    16    0.076    0.469
  0.00 100.00  28.57  80.25  96.48  90.13     25    0.416     0    0.000    16    0.076    0.492
  0.00 100.00   0.00  82.94  96.48  90.14     27    0.429     0    0.000    16    0.076    0.505
  0.00 100.00   0.00  84.83  96.48  90.14     29    0.446     0    0.000    18    0.084    0.531
  0.00 100.00  60.00  85.73  96.48  90.14     30    0.457     0    0.000    18    0.084    0.541
  0.00 100.00  60.00  88.95  96.48  90.14     33    0.478     0    0.000    18    0.084    0.562
  0.00 100.00   0.00  93.92  96.48  90.14     35    0.497     0    0.000    20    0.092    0.589
  0.00 100.00   0.00  87.31  96.48  90.14     37    0.511     0    0.000    22    0.108    0.619
  0.00 100.00  33.33  88.54  96.48  90.14     38    0.520     0    0.000    24    0.116    0.636
  0.00 100.00   0.00  91.14  96.48  90.14     40    0.542     0    0.000    26    0.125    0.666
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00 100.00   0.00  92.50  96.48  90.14     41    0.548     0    0.000    26    0.125    0.672
  0.00 100.00  16.67  93.93  96.48  90.14     42    0.557     0    0.000    28    0.133    0.690
  0.00 100.00  66.67  93.64  96.48  90.14     43    0.565     0    0.000    30    0.143    0.708
  0.00 100.00  33.33  97.33  96.48  90.14     45    0.583     0    0.000    30    0.143    0.726
  0.00 100.00  50.00  96.97  96.48  90.14     46    0.595     0    0.000    32    0.153    0.748
  0.00 100.00   0.00 100.00  96.48  90.14     48    0.619     1    0.000    32    0.153    0.773
  0.00 100.00  33.33  95.97  96.48  90.14     50    0.630     1    0.197    34    0.165    0.991
  0.00 100.00  66.67  97.41  96.48  90.14     52    0.642     1    0.197    35    0.175    1.014
  0.00   0.00  60.00  99.43  96.48  90.14     55    0.671     3    0.617    36    0.175    1.464
  0.00   0.00   0.00  99.33  96.49  90.14     59    0.698     7    1.284    36    0.175    2.157
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   
  0.00   0.00   0.00  99.97  96.49  90.14     63    0.713    12    2.343    36    0.175    3.231
  0.00   0.00   0.00  99.97  96.49  90.14     65    0.715    17    3.406    36    0.175    4.297
  0.00   0.00   0.00  99.97  96.49  90.14     67    0.722    21    4.257    36    0.175    5.155
  0.00   0.00   0.00  99.97  96.49  90.14     70    0.727    26    5.319    36    0.175    6.222
  0.00   0.00   0.00  99.97  96.49  90.14     72    0.731    31    6.365    36    0.175    7.271
  0.00   0.00   0.00  99.97  96.49  90.14     74    0.738    35    7.422    36    0.175    8.335
  0.00   0.00   0.00  99.97  96.49  90.14     77    0.742    40    8.265    36    0.175    9.182
  0.00   0.00   0.00  99.97  96.49  90.14     79    0.745    45    9.328    36    0.175   10.248
  0.00   0.00   0.00  99.97  96.49  90.14     82    0.751    50   10.379    36    0.175   11.305
  0.00   0.00   0.00  99.97  96.49  90.14     82    0.751    50   10.589    36    0.175   11.516
```
然后我们用 Eclipse MAT 查看一下堆dump，
![](/工具/chart/overview.png)

从上图中我们可以看到 HelloController 中的对象占了 109M的堆内存，然后我们list object，查看具体是哪个对象：

![](/工具/chart/list_object.png)

从上图中我们看到是GLOBAL_SET 这个变量占用了大量的内存。
